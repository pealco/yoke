name: CI

on:
  pull_request:
  push:
    branches:
      - main
  workflow_dispatch:

concurrency:
  group: ci-${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read

jobs:
  quality:
    name: Quality Gate (Go from go.mod)
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version-file: go.mod
          cache: true

      - name: Run quality checks
        run: make ci

  race-tests:
    name: Race Tests
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version-file: go.mod
          cache: true

      - name: Run race detector tests
        run: make test-race

  compatibility:
    name: Compatibility (Go stable)
    runs-on: ubuntu-latest
    timeout-minutes: 20

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Go stable
        uses: actions/setup-go@v5
        with:
          go-version: stable
          cache: true

      - name: Run compatibility test suite
        run: go test ./...

  build-smoke:
    name: Build Smoke (${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    timeout-minutes: 20
    strategy:
      fail-fast: false
      matrix:
        os:
          - ubuntu-latest
          - macos-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version-file: go.mod
          cache: true

      - name: Build yoke binary
        run: go build ./cmd/yoke

  release-smoke:
    name: Release Matrix Smoke
    runs-on: ubuntu-latest
    timeout-minutes: 20

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version-file: go.mod
          cache: true

      - name: Build release binaries
        run: make release

      - name: Verify release outputs
        run: |
          test -f dist/yoke_darwin_amd64
          test -f dist/yoke_darwin_arm64
          test -f dist/yoke_linux_amd64
          test -f dist/yoke_linux_arm64

  dependency-review:
    name: Dependency Review
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-latest
    timeout-minutes: 10
    permissions:
      contents: read
      pull-requests: read

    steps:
      - name: Check dependency changes for known vulnerabilities
        uses: actions/dependency-review-action@v4
